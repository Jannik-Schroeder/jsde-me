---
title: Install HA k3s with Traefik, CertManager, and a Virtual IP
date: '2023-11-2'
tags: ['k3s', 'kubernetes', 'traefik', 'cert-manager', 'virtual-ip']
draft: false
summary: 'Install HA k3s with Traefik, CertManager, and a Virtual IP'
images: []
layout: PostLayout
canonicalUrl:
---

# Installing HA k3s with Traefik, Cert-Manager, and a Virtual IP

```sh
# Master Configuration
apt-get update && apt-get upgrade && apt-get install curl keepalived vim
echo 'vrrp_instance VI_1 {
  state MASTER
  interface eth0  # Replace with your active network interface
  virtual_router_id 91
  priority 100
  virtual_ipaddress {
      10.1.0.91 # Any free IP in the network
  }
}' > /etc/keepalived/keepalived.conf
systemctl restart keepalived
curl -sfL https://get.k3s.io/ | sh -s - server --token=EXAMPLE_TOKEN --tls-san 10.1.0.91 --disable=traefik --cluster-init

# Slave Nodes Setup
apt-get update && apt-get upgrade && apt-get install curl keepalived vim
echo 'vrrp_instance VI_1 {
  state MASTER
  interface eth0  # Replace with your active network interface
  virtual_router_id 91
  priority 100
  virtual_ipaddress {
      10.1.0.91 # Same IP as the other nodes
  }
}' > /etc/keepalived/keepalived.conf
systemctl restart keepalived
curl -sfL https://get.k3s.io/ | sh -s - server --token=EXAMPLE_TOKEN --tls-san 10.1.0.91 --disable=traefik --server https://ipv4-first-server:6443/

# Certmanager Installation
mkdir certmanager && cd certmanager
echo 'installCRDs: false
replicaCount: 3
extraArgs:
  - --dns01-recursive-nameservers=1.1.1.1:53,9.9.9.9:53
  - --dns01-recursive-nameservers-only
podDnsPolicy: None
podDnsConfig:
  nameservers:
    - 1.1.1.1
    - 9.9.9.9' > values.yaml
echo 'apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-key-secret
  namespace: cert-manager
type: Opaque
stringData:
  api-key: GLOBAL-API-KEY' > secret-cf-token.yaml
echo 'apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-production
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: CLOUDFLARE-EMAIL
    privateKeySecretRef:
      name: letsencrypt-production
    solvers:
      - dns01:
          cloudflare:
            email: CLOUDFLARE-EMAIL
            apiKeySecretRef:
              name: cloudflare-api-key-secret
              key: api-key' > letsencrypt-production.yaml
helm repo add jetstack https://charts.jetstack.io
helm repo update
helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.13.1 --values=values.yaml --set installCRDs=true
kubectl apply -f secret-cf-token.yaml
kubectl apply -f letsencrypt-production.yaml

# Traefik Installation
mkdir traefik && cd traefik
echo 'globalArguments:
  - "--global.sendanonymoususage=false"
  - "--global.checknewversion=false"
additionalArguments:
  - "--serversTransport.insecureSkipVerify=true"
  - "--accesslog=true"
  - "--log.level=INFO"
deployment:
  enabled: true
  replicas: 3
ports:
  web:
    redirectTo: websecure
  websecure:
    tls:
      enabled: true
providers:
  kubernetesCRD:
    enabled: true
    ingressClass: traefik-external
    allowExternalNameServices: true
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    publishedService:
      enabled: false
rbac:
  enabled: true' > values.yaml
helm repo add traefik https://traefik.github.io/charts
helm install traefik traefik/traefik -f values.yaml -n traefik
echo 'apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard
  namespace: traefik
  annotations:
    kubernetes.io/ingress.class: traefik-external
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`DOMAIN.TLD`)
      kind: Rule
      services:
        - name: api@internal
          kind: TraefikService
  tls:
    secretName: traefik-tls
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: traefik-tls
  namespace: traefik
spec:
  secretName: traefik-tls
  issuerRef:
    name: letsencrypt-production
    kind: ClusterIssuer
  dnsNames:
    - DOMAIN.TLD' > dashboard.yaml
kubectl apply -f dashboard.yaml
